<configuration scan="true" scanPeriod="30 seconds" debug="false">
    <springProperty scope="context" name="LOG_LEVEL" source="LOG_LEVEL" defaultValue="INFO"/>
    <springProperty scope="context" name="APP_LOG_LEVEL" source="LOG_LEVEL" defaultValue="INFO"/>
    <springProperty scope="context" name="SPRING_SECURITY_LOG_LEVEL" source="SPRING_SECURITY_LOG_LEVEL" defaultValue="INFO"/>

    <springProperty scope="context" name="LOG_FILE_ENABLED" source="LOG_FILE_ENABLED" defaultValue="true"/>
    <springProperty scope="context" name="LOG_JSON_ENABLED" source="LOG_JSON_ENABLED" defaultValue="false"/>
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="authorization-service"/>
    <springProperty scope="context" name="APP_VERSION" source="app.version" defaultValue="1.0.0"/>

    <!-- File locations -->
    <springProperty scope="context" name="LOG_FILE_PATH" source="LOG_FILE_PATH" defaultValue="logs/app.log"/>
    <springProperty scope="context" name="LOG_ERROR_FILE_PATH" source="LOG_ERROR_FILE_PATH" defaultValue="logs/error.log"/>
    <springProperty scope="context" name="LOG_ADMIN_FILE_PATH" source="LOG_ADMIN_FILE_PATH" defaultValue="logs/admin.log"/>

    <!-- Rotation -->
    <springProperty scope="context" name="LOG_MAX_HISTORY" source="LOG_MAX_HISTORY" defaultValue="30"/>
    <springProperty scope="context" name="LOG_MAX_SIZE" source="LOG_MAX_SIZE" defaultValue="10MB"/>
    <springProperty scope="context" name="LOG_TOTAL_SIZE_CAP" source="LOG_TOTAL_SIZE_CAP" defaultValue="1GB"/>

    <property name="LOGBACK_SKIP_JANSI" value="true"/>

    <property name="LOG_PATTERN"
              value="%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} [%level] [%thread] trace=%X{traceId:-none} user=%X{userEmail:-anon} ip=%X{clientIp:-unknown} method=%X{httpMethod:-unknown} path=%X{requestPath:-unknown} %logger{36} - %msg%n"/>

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <charset>UTF-8</charset>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <if condition='property("LOG_FILE_ENABLED").equalsIgnoreCase("true")'>
        <then>
            <!-- General rolling file -->
            <appender name="FILE_APP" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <file>${LOG_FILE_PATH}</file>
                <append>true</append>
                <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
                    <charset>UTF-8</charset>
                    <pattern>${LOG_PATTERN}</pattern>
                </encoder>
                <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                    <fileNamePattern>${LOG_FILE_PATH}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
                    <maxFileSize>${LOG_MAX_SIZE}</maxFileSize>
                    <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
                    <totalSizeCap>${LOG_TOTAL_SIZE_CAP}</totalSizeCap>
                    <cleanHistoryOnStart>false</cleanHistoryOnStart>
                </rollingPolicy>
            </appender>

            <!-- Errors/Warns rolling file -->
            <appender name="FILE_ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <file>${LOG_ERROR_FILE_PATH}</file>
                <append>true</append>
                <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                    <level>WARN</level>
                </filter>
                <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
                    <charset>UTF-8</charset>
                    <pattern>${LOG_PATTERN}</pattern>
                </encoder>
                <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                    <fileNamePattern>${LOG_ERROR_FILE_PATH}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
                    <maxFileSize>${LOG_MAX_SIZE}</maxFileSize>
                    <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
                    <totalSizeCap>${LOG_TOTAL_SIZE_CAP}</totalSizeCap>
                    <cleanHistoryOnStart>false</cleanHistoryOnStart>
                </rollingPolicy>
            </appender>

            <!-- Admin actions rolling file -->
            <appender name="FILE_ADMIN" class="ch.qos.logback.core.rolling.RollingFileAppender">
                <file>${LOG_ADMIN_FILE_PATH}</file>
                <append>true</append>
                <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
                    <charset>UTF-8</charset>
                    <pattern>${LOG_PATTERN}</pattern>
                </encoder>
                <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                    <fileNamePattern>${LOG_ADMIN_FILE_PATH}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
                    <maxFileSize>${LOG_MAX_SIZE}</maxFileSize>
                    <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
                    <totalSizeCap>${LOG_TOTAL_SIZE_CAP}</totalSizeCap>
                    <cleanHistoryOnStart>false</cleanHistoryOnStart>
                </rollingPolicy>
            </appender>
        </then>
    </if>

    <if condition='property("LOG_JSON_ENABLED").equalsIgnoreCase("true")'>
        <then>
            <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
                <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                    <providers>
                        <timestamp/>
                        <version/>
                        <logLevel/>
                        <threadName/>
                        <loggerName/>
                        <mdc/>
                        <message/>
                        <arguments/>
                        <stackTrace/>
                    </providers>
                    <customFields>{"app_name":"${APP_NAME}","app_version":"${APP_VERSION}","hostname":"${HOSTNAME:-unknown}"}</customFields>
                </encoder>
            </appender>

            <if condition='property("LOG_FILE_ENABLED").equalsIgnoreCase("true")'>
                <then>
                    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
                        <file>${LOG_FILE_PATH}.json</file>
                        <append>true</append>
                        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                            <providers>
                                <timestamp/>
                                <version/>
                                <logLevel/>
                                <threadName/>
                                <loggerName/>
                                <mdc/>
                                <message/>
                                <arguments/>
                                <stackTrace/>
                            </providers>
                            <customFields>{"app_name":"${APP_NAME}","app_version":"${APP_VERSION}","hostname":"${HOSTNAME:-unknown}"}</customFields>
                        </encoder>
                        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                            <fileNamePattern>${LOG_FILE_PATH}.json.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
                            <maxFileSize>${LOG_MAX_SIZE}</maxFileSize>
                            <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
                            <totalSizeCap>${LOG_TOTAL_SIZE_CAP}</totalSizeCap>
                            <cleanHistoryOnStart>false</cleanHistoryOnStart>
                        </rollingPolicy>
                    </appender>
                </then>
            </if>
        </then>
    </if>

    <logger name="org.springframework.security" level="${SPRING_SECURITY_LOG_LEVEL}" additivity="false">
        <appender-ref ref="CONSOLE"/>
    </logger>

    <logger name="com.authenticationservice.admin" level="INFO" additivity="false">
        <appender-ref ref="CONSOLE"/>
    </logger>

    <logger name="com.authenticationservice" level="${APP_LOG_LEVEL}" additivity="false">
        <appender-ref ref="CONSOLE"/>
    </logger>

    <root level="${LOG_LEVEL}">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>

