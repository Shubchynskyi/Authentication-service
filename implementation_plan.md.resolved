# План реализации защиты от брутфорса

## Описание цели
Улучшить существующую систему аутентификации для защиты от атак методом перебора (брутфорс) и повышения общей безопасности. В настоящее время система блокирует аккаунты навсегда после 10 неудачных попыток, что делает её уязвимой для DoS-атак (любой может заблокировать чужой аккаунт).

## Требуется проверка пользователем
> [!IMPORTANT]
> Пожалуйста, выберите один из предложенных вариантов защиты.

### Вариант 1: Временная блокировка аккаунта (Рекомендуется)
- **Механизм**: После 5 неудачных попыток блокировать аккаунт на 15 минут.
- **Плюсы**: Предотвращает постоянный DoS; пользователь может повторить попытку позже без сброса пароля.
- **Минусы**: Злоумышленник все еще может временно блокировать пользователей, если знает email.
- **Изменения**: Изменить сущность [User](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/model/User.java#11-119) (добавить `lockTime`). Обновить [AuthService](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/service/AuthService.java#30-346) для проверки/установки времени блокировки.

### Вариант 2: Ограничение частоты запросов по IP (Rate Limiting)
- **Механизм**: Ограничить количество попыток входа с одного IP-адреса (например, 20 запросов в час).
- **Плюсы**: Блокирует атакующего, не затрагивая легитимного пользователя (если у них разные IP).
- **Минусы**: Может блокировать легитимных пользователей за общим NAT/прокси (офисы, университеты).
- **Реализация**: Добавить фильтр/интерцептор (Bucket4j или in-memory map).

### Вариант 3: Гибридный (Лучший баланс)
- **Механизм**: Внедрить **Временную блокировку** И **Ограничение по IP**.
- **Плюсы**: Надежная защита.

## Предлагаемые изменения (На основе Варианта 1 - Временная блокировка)

### Backend
#### [MODIFY] [User.java](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/model/User.java)
- Добавить поле `lockTime` (LocalDateTime).
- Удалить или перепрофилировать `blocked` (или оставить для бана админом).
- Обновить [incrementFailedLoginAttempts](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/model/User.java#101-109), чтобы устанавливать `lockTime` вместо вечной блокировки.

#### [MODIFY] [AuthService.java](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/service/AuthService.java)
- В методе [login](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/service/AuthService.java#112-191):
    - Проверять, активно ли `lockTime`. Если да, выбрасывать исключение "Попробуйте через X минут".
    - Если пароль неверный: увеличивать счетчик. Если порог достигнут, устанавливать `lockTime`.
    - Если пароль верный: сбрасывать счетчик и `lockTime`.

## Анализ безопасности и другие уязвимости
1.  **Отказ в обслуживании (DoS)**: Текущая "вечная блокировка после 10 попыток" позволяет любому заблокировать пользователя, зная его email. **Решение**: Переход на временную блокировку.
2.  **Слабая политика паролей**: Нужно проверить, требует ли [RegistrationRequest](file:///d:/Projects/Authentication-service/backend/src/main/java/com/authenticationservice/dto/RegistrationRequest.java#6-23) сложности пароля.
3.  **Хранение токенов**: Токены возвращаются в теле ответа. **Рекомендация**: Хранить Refresh Token в HttpOnly Cookie для защиты от XSS.
4.  **Отсутствие 2FA**: Нет двухфакторной аутентификации. **Рекомендация**: Предложить внедрение TOTP (Google Authenticator).
5.  **Утечка информации**: Сообщения об ошибках входа могут раскрывать существование пользователя ("Пользователь не найден" vs "Неверный пароль"). **Рекомендация**: Использовать общие сообщения "Неверный email или пароль".

## План проверки
### Автоматизированные тесты
- Создать `AuthServiceTest` для проверки:
    - Аккаунт блокируется после N неудач.
    - Аккаунт разблокируется после истечения времени.
    - Успешный вход сбрасывает счетчики.
